# ==================================
# TnD System - Backend .htaccess (Production)
# Minimal & Safe Configuration for cPanel
# ==================================

# Disable directory listing
Options -Indexes

# Set Default Index
DirectoryIndex index.php

# Enable Rewrite Engine
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Fix Authorization Header (CRITICAL for Bearer Token)
    # cPanel/Apache strips Authorization header by default
    RewriteCond %{HTTP:Authorization} ^(.+)$
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
    
    # Handle preflight OPTIONS requests
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]
</IfModule>

# CORS Headers - Allow HTTPS Frontend
<IfModule mod_headers.c>
    # Pass Authorization header to PHP (CRITICAL!)
    SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
    
    # Allow credentials (for session/cookies)
    Header always set Access-Control-Allow-Credentials "true"
    
    # Allow HTTPS origin
    Header always set Access-Control-Allow-Origin "https://tndsystem.online"
    
    # Allow HTTP origin (fallback)
    Header always set Access-Control-Allow-Origin "http://tndsystem.online"
    
    # Allow methods
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    
    # Allow headers (including Authorization!)
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-Api-Key"
    
    # Preflight cache
    Header always set Access-Control-Max-Age "3600"
</IfModule>

# Protect .env file
<Files ".env">
    Order Allow,Deny
    Deny from all
</Files>

# Protect sensitive files
<FilesMatch "\.(log|sql|md|bat|sh|git)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# PHP Error Settings
<IfModule mod_php7.c>
    php_flag display_errors Off
    php_flag log_errors On
    php_value error_log logs/error.log
    php_value upload_max_filesize 20M
    php_value post_max_size 25M
    php_value max_execution_time 300
</IfModule>

<IfModule mod_php8.c>
    php_flag display_errors Off
    php_flag log_errors On
    php_value error_log logs/error.log
    php_value upload_max_filesize 20M
    php_value post_max_size 25M
    php_value max_execution_time 300
</IfModule>
