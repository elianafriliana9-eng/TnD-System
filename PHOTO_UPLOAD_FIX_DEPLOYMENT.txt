â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  TND SYSTEM - PHOTO UPLOAD FIX DEPLOYMENT SUMMARY             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ› ISSUE FIXED:
---------------
Error 1: SQLSTATE[42S22]: Column not found: 1054 Unknown column 'checklist_item_id' 
         in visit_photos table
Error 2: SQLSTATE[42S22]: Column not found: 1054 Unknown column 'checklist_item_id' 
         in visit_checklist_responses table
Status: Photo upload fails with HTTP 500
Status: Checklist responses fail with HTTP 500
Impact: Users cannot upload photos OR save checklist responses during visits

ğŸ”§ ROOT CAUSE:
--------------
Database tables missing column 'checklist_item_id':
  1. visit_photos table - MISSING checklist_item_id
  2. visit_checklist_responses table - MISSING checklist_item_id
  
Mobile app and PHP code expect these columns but production database doesn't have them.
This is a schema mismatch between production SQL export and actual production database.

âœ… SOLUTION:
------------
1. Add missing column to visit_photos: checklist_item_id INT NULL
2. Add missing column to visit_checklist_responses: checklist_item_id INT NOT NULL
3. Add foreign key constraints to checklist_points table
4. Enhanced error logging in backend PHP files

ğŸ“¦ FILES TO UPLOAD (14 files):
------------------------------

Backend PHP Files (12):
  1. .htaccess
  2. api/outlets.php
  3. api/report-overview.php
  4. api/report-by-outlet.php
  5. api/improvement-recommendations.php
  6. api/visits-create.php
  7. api/visit-complete.php
  8. api/visit-photo-upload.php
  9. utils/Auth.php
  10. classes/Visit.php
  11. classes/Audit.php
  12. classes/Outlet.php

Setup Scripts (2):
  13. create-upload-dirs.php
  14. migrate-database-complete.php (REPLACES migrate-visit-photos.php)

ğŸš€ DEPLOYMENT PROCEDURE (DO IN ORDER!):
---------------------------------------

STEP 1: BACKUP DATABASE
  - Login to cPanel â†’ phpMyAdmin
  - Export database 'tnd_system' (Quick export, SQL format)
  - Save backup file locally

STEP 2: UPLOAD FILES
  - Login to cPanel â†’ File Manager
  - Navigate to: public_html/backend-web/
  - Upload all 14 files (overwrite existing)
  - Verify file permissions (644 for PHP files)

STEP 3: CREATE UPLOAD DIRECTORIES
  - Open browser: https://tndsystem.online/backend-web/create-upload-dirs.php
  - Wait for "âœ… Created" messages
  - Verify 4 directories created:
    â€¢ uploads/visit_photos/
    â€¢ uploads/profile_photos/
    â€¢ uploads/training_photos/
    â€¢ uploads/temp/
  - **DELETE create-upload-dirs.php immediately!**

STEP 4: RUN DATABASE MIGRATION
  - Open browser: https://tndsystem.online/backend-web/migrate-database-complete.php
  - Wait for migration to complete
  - Verify both tables updated:
    âœ… visit_photos.checklist_item_id added
    âœ… visit_checklist_responses.checklist_item_id added
  - Check foreign key constraints added
  - **DELETE migrate-database-complete.php immediately!**

STEP 5: REBUILD MOBILE APP
  cd C:\laragon\www\tnd_system\tnd_system\tnd_mobile_flutter
  flutter clean
  flutter pub get
  flutter build apk --release
  
  APK Location: build/app/outputs/flutter-apk/app-release.apk

STEP 6: TEST
  - Install new APK on device
  - Login to app
  - Start a visit
  - Take a photo (should compress to ~50-100KB)
  - Upload photo
  - Verify: HTTP 200 (not 500)
  - Check: Photo appears in visit details

ğŸ” VERIFICATION CHECKLIST:
--------------------------
[ ] Database backup created
[ ] 14 files uploaded to cPanel
[ ] Upload directories created (4 dirs)
[ ] create-upload-dirs.php deleted
[ ] Database migration completed
[ ] checklist_item_id column exists
[ ] migrate-visit-photos.php deleted
[ ] Mobile app rebuilt
[ ] New APK installed
[ ] Photo upload test: SUCCESS (HTTP 200)
[ ] Photo visible in app
[ ] Photo file exists on server (uploads/visit_photos/)

ğŸ“Š EXPECTED RESULTS:
--------------------
Before Fix:
  âŒ Upload Photo Status: 500
  âŒ Error: Column 'checklist_item_id' not found
  âŒ Photo upload failed

After Fix:
  âœ… Upload Photo Status: 200
  âœ… Photo saved to database with checklist_item_id
  âœ… Photo file created in uploads/visit_photos/
  âœ… Photo compressed to ~50-100KB (from 196KB)

ğŸ†˜ TROUBLESHOOTING:
-------------------
If migration fails:
  1. Check database user has ALTER TABLE permissions
  2. Run SQL manually via phpMyAdmin:
     ALTER TABLE visit_photos ADD COLUMN checklist_item_id INT NULL AFTER visit_id;
  3. Check error in migration page output

If photo upload still fails:
  1. Check backend-web/logs/app.log for errors
  2. Verify uploads/visit_photos/ directory exists and writable (755)
  3. Check cPanel error_log
  4. Test with curl:
     curl -H "Authorization: Bearer YOUR_TOKEN" \
          -F "visit_id=5" \
          -F "photo=@photo.jpg" \
          https://tndsystem.online/backend-web/api/visit-photo-upload.php

If column still not found:
  1. Verify migration actually ran (check table structure)
  2. Check correct database is being used
  3. Clear PHP opcache if enabled

ğŸ“ ROLLBACK PROCEDURE (if needed):
----------------------------------
1. Restore database backup from Step 1
2. Re-upload old PHP files
3. Delete new files

â±ï¸ ESTIMATED TIME:
------------------
- Upload files: 5 minutes
- Run scripts: 2 minutes
- Rebuild app: 3-5 minutes
- Testing: 5 minutes
Total: ~15-20 minutes

ğŸ”’ SECURITY NOTES:
------------------
1. DELETE setup scripts immediately after use
2. Never commit database credentials to git
3. Keep database backup in secure location
4. Monitor logs after deployment

ğŸ“ SUPPORT:
-----------
If issues persist:
1. Check backend-web/logs/app.log
2. Check cPanel error_log
3. Review migration output for errors
4. Verify database structure manually

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Last Updated: November 2, 2024
Version: 1.0
Status: Ready for Production Deployment ğŸš€
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
